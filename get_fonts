#!/bin/bash

# XXX requires wget and fc-query

DEST_DIR=public/fonts
DEST_CSS=$DEST_DIR/defs.css
SCRIPT_NAME=$(basename $(readlink -f $0))
CACHE_DIR=~/.cache/$SCRIPT_NAME

get_font(){
    URL=$1
    shift
    BASENAME=$(echo "$URL"|awk -F/ '{print $NF}' )
    LOCAL_NAME="$CACHE_DIR/$BASENAME"
    echo "Downloading $URL to $LOCAL_NAME"
    wget -c -q -O "$LOCAL_NAME" "$URL"
    echo "Extracting fonts from $LOCAL_NAME"
    unzip -q "$LOCAL_NAME" "$@" -d ${DEST_DIR}
}

flatten(){
    INDIR=$1
    TMPD=$(mktemp -d)
    echo Flatenning $INDIR
    find $INDIR/ -type f | xargs -I@ mv @ $TMPD/
    rm -rf $INDIR/
    mkdir -p $INDIR
    mv $TMPD/* $INDIR/
    rm -rf $TMPD
}

generate_css(){
    INDIR=$1
    echo "Generating CSS definition file" >&2
    echo "/* Generated by $SCRIPT_NAME on $(date -u) */"
    for font_file in $INDIR/*.ttf; do
        FONT_FAMILY=$(fc-query ${font_file}|awk -F\" '/family:/{print $2}')
        # echo "${font_file} $FONT_FAMILY"
        echo "@font-face {
  font-family: '$FONT_FAMILY';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url("$(basename "$font_file")") format('truetype');
}
"
    done
}

main(){
    rm -rf ${DEST_DIR}
    mkdir -p ${DEST_DIR} ${CACHE_DIR}

    get_font https://github.com/source-foundry/Hack/releases/download/v3.003/Hack-v3.003-ttf.zip '**/Hack-Regular.ttf'
    get_font https://github.com/microsoft/cascadia-code/releases/download/v2111.01/CascadiaCode-2111.01.zip '**/*-Regular.ttf'

    flatten ${DEST_DIR}
    
    generate_css ${DEST_DIR} > ${DEST_CSS}.tmp
    mv ${DEST_CSS}.tmp ${DEST_CSS}
}

main
